name: Test Aspose HarfBuzz on Darwin (macOS)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-macos-intel:
    name: macOS Intel (x86_64)
    runs-on: macos-13  # Intel chip
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Display Darwin/macOS system info
      run: |
        echo "====== DARWIN/macOS SYSTEM INFO ======"
        echo "Kernel: $(uname -s)"
        echo "Kernel Version: $(uname -r)"
        echo "Darwin Release: $(uname -v)"
        echo "Architecture: $(uname -m)"
        echo "Processor: $(uname -p)"
        echo "Hardware: $(uname -m)"
        sw_vers
        system_profiler SPSoftwareDataType SPHardwareDataType
        echo "======================================"
        
    - name: Display Java info
      run: |
        echo "====== JAVA INFO ======"
        java -version
        echo "Java Home: $JAVA_HOME"
        java -XshowSettings:properties -version 2>&1 | grep "os\|user\|file"
        echo "======================="
        
    - name: Check HarfBuzz availability on Darwin
      run: |
        echo "====== HARFBUZZ CHECK ======"
        # Provjeri da li HarfBuzz postoji na sistemu
        if brew list harfbuzz &>/dev/null; then
          echo "HarfBuzz is installed via Homebrew"
          brew info harfbuzz
        else
          echo "HarfBuzz not found via Homebrew"
        fi
        
        # Provjeri native biblioteke
        find /usr/local/lib /opt/homebrew/lib -name "*harfbuzz*" 2>/dev/null || echo "No HarfBuzz libs found"
        echo "==========================="
        
    - name: Build with Maven
      run: mvn clean compile
      
    - name: Run HarfBuzz test on Darwin
      run: mvn exec:java -Dexec.mainClass="com.test.HarfBuzzTest"
      
    - name: Upload Darwin test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-outputs-darwin-intel
        path: |
          *.docx
          *.pdf
          test-report.txt
        retention-days: 7

  test-macos-arm:
    name: macOS Apple Silicon (ARM64)
    runs-on: macos-latest  # Apple Silicon (M-series)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Display Darwin/macOS system info
      run: |
        echo "====== DARWIN/macOS ARM64 SYSTEM INFO ======"
        echo "Kernel: $(uname -s)"
        echo "Kernel Version: $(uname -r)"
        echo "Darwin Release: $(uname -v)"
        echo "Architecture: $(uname -m)"
        echo "Processor: $(uname -p)"
        sw_vers
        system_profiler SPSoftwareDataType SPHardwareDataType
        echo "=========================================="
        
    - name: Display Java info
      run: |
        echo "====== JAVA INFO ======"
        java -version
        java -XshowSettings:properties -version 2>&1 | grep "os\|user\|file"
        echo "======================="
        
    - name: Check HarfBuzz on ARM64 Darwin
      run: |
        echo "====== HARFBUZZ CHECK (ARM64) ======"
        if brew list harfbuzz &>/dev/null; then
          echo "HarfBuzz is installed via Homebrew"
          brew info harfbuzz
        else
          echo "HarfBuzz not found via Homebrew"
        fi
        
        find /usr/local/lib /opt/homebrew/lib -name "*harfbuzz*" 2>/dev/null || echo "No HarfBuzz libs found"
        echo "===================================="
        
    - name: Build with Maven
      run: mvn clean compile
      
    - name: Run HarfBuzz test on Darwin ARM64
      run: mvn exec:java -Dexec.mainClass="com.test.HarfBuzzTest"
      
    - name: Upload Darwin ARM64 test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-outputs-darwin-arm64
        path: |
          *.docx
          *.pdf
          test-report.txt
        retention-days: 7

  test-linux:
    name: Linux (for comparison)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Display Linux system info
      run: |
        echo "====== LINUX SYSTEM INFO ======"
        uname -a
        lsb_release -a
        echo "==============================="
        
    - name: Install fonts and HarfBuzz
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-liberation fonts-dejavu libharfbuzz-dev
        dpkg -l | grep harfbuzz
        
    - name: Build with Maven
      run: mvn clean compile
      
    - name: Run HarfBuzz test on Linux
      run: mvn exec:java -Dexec.mainClass="com.test.HarfBuzzTest"
      
    - name: Upload Linux test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-outputs-linux
        path: |
          *.docx
          *.pdf
          test-report.txt
        retention-days: 7
